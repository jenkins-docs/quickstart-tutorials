---
name: 'deps(devcontainer): update Docker and GitHub CLI versions'

scms:
  default:
    kind: github
    spec:
      user: "{{ .github.user }}"
      email: "{{ .github.email }}"
      owner: "{{ .github.owner }}"
      repository: "{{ .github.repository }}"
      token: "{{ requiredEnv .github.token }}"
      username: "{{ .github.username }}"
      branch: "{{ .github.branch }}"

sources:
  dockerLatestMinor:
    name: Get latest Docker minor version
    kind: githubrelease
    spec:
      owner: moby
      repository: moby
      token: "{{ requiredEnv .github.token }}"
      versionfilter:
        kind: semver
        pattern: '~27.0'

  githubcliLatestMinor:
    name: Get latest GitHub CLI minor version
    kind: githubrelease
    spec:
      owner: cli
      repository: cli
      token: "{{ requiredEnv .github.token }}"
      versionfilter:
        kind: semver
        pattern: '>=2.62.0'

targets:
  dockerVersion:
    name: 'deps(devcontainer): update Docker version'
    scmid: default
    kind: file
    sourceid: dockerLatestMinor
    spec:
      file: .devcontainer/devcontainer.json
      matchpattern: '("version": ")(v?[0-9.]+)(")'
      replacepattern: '${1}v{{ source "dockerLatestMinor" }}${3}'
      content: |
        "ghcr.io/devcontainers/features/docker-in-docker:2": {
          "version": "{{ source "dockerLatestMinor" }}",
    transformers:
      - trimprefix: v

  githubcliVersion:
    name: 'deps(devcontainer): update GitHub CLI version'
    scmid: default
    kind: file
    sourceid: githubcliLatestMinor
    spec:
      file: .devcontainer/devcontainer.json
      matchpattern: '("version": ")(v?[0-9.]+)(")'
      replacepattern: '${1}v{{ source "githubcliLatestMinor" }}${3}'
      content: |
        "ghcr.io/devcontainers/features/github-cli:1": {
          "version": "{{ source "githubcliLatestMinor" }}"
    transformers:
      - trimprefix: v

actions:
  default:
    kind: github/pullrequest
    scmid: default
    title: 'chore(deps): update devcontainer dependencies'
    spec:
      labels:
        - dependencies
        - devcontainer
